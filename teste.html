<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Chat Realtime - Online & Digitando</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        #chat-container { max-width: 500px; margin: auto; background: #2d2d2d; padding: 20px; border-radius: 8px; }
        
        /* Lista de Online */
        #online-status { font-size: 12px; margin-bottom: 10px; padding: 8px; background: #121212; border-radius: 4px; color: #4ade80; }
        
        #messages { height: 300px; overflow-y: auto; border: 1px solid #444; background: #121212; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; flex-direction: column; }
        
        /* Indicador de Digitando */
        #typing-indicator { height: 20px; font-size: 11px; color: #aaa; margin-bottom: 10px; font-style: italic; }
        
        .msg-box { margin-bottom: 8px; padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 14px; position: relative; }
        .mine { align-self: flex-end; background: #0084ff; color: white; }
        .others { align-self: flex-start; background: #3e3e3e; color: #e0e0e0; }
        .user-label { font-size: 10px; opacity: 0.7; display: block; }
        
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #444; margin-bottom: 5px; }
        input { background: #333; color: white; width: calc(100% - 22px); }
        button { width: 100%; background: #3eaf7c; color: white; cursor: pointer; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="online-status">游논 Usu치rios online: 0</div>
        
        <div id="messages"></div>
        <div id="typing-indicator"></div>

        <input type="text" id="userName" placeholder="Seu Nome">
        <input type="text" id="messageInput" placeholder="Digite sua mensagem...">
        <button id="btnEnviar">Enviar Mensagem</button>
    </div>

    <script type="module">
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

        if (!SUPABASE_URL || !SUPABASE_KEY) {
            throw new Error('Credenciais do Supabase n칚o encontradas. Verifique VITE_SUPABASE_URL e VITE_SUPABASE_ANON_KEY no .env e rode via Vite (npm run dev).');
        }

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const messagesDiv = document.getElementById('messages');
        const onlineStatusDiv = document.getElementById('online-status');
        const typingDiv = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('messageInput');
        const userNameInput = document.getElementById('userName');

        // Gerar um ID 칰nico para esta sess칚o para n칚o confundir o "digitando" comigo mesmo
        const myId = Math.random().toString(36).substring(7);

        const canalChat = supabaseClient.channel('chat-teste', {
            config: { 
                broadcast: { self: false }, // N칚o quero receber meus pr칩prios broadcasts de digita칞칚o
                presence: { key: myId } 
            }
        });

        // --- 1. L칍GICA DE PRESEN칂A (ONLINE) ---
        canalChat
            .on('presence', { event: 'sync' }, () => {
                const state = canalChat.presenceState();
                const usersOnline = Object.values(state).map(presence => presence[0].user || 'An칪nimo');
                onlineStatusDiv.innerText = `游논 Online agora (${usersOnline.length}): ${usersOnline.join(', ')}`;
            })
            // --- 2. L칍GICA DE DIGITANDO (BROADCAST) ---
            .on('broadcast', { event: 'typing' }, (payload) => {
                const { nome, isTyping } = payload.payload;
                if (isTyping) {
                    typingDiv.innerText = `${nome} est치 digitando...`;
                } else {
                    typingDiv.innerText = '';
                }
            })
            // --- 3. L칍GICA DE MENSAGENS ---
            .on('broadcast', { event: 'nova-mensagem' }, (payload) => {
                renderMessage(payload.payload.nome, payload.payload.texto, false);
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    // Quando conectar, come칞a a rastrear minha presen칞a
                    const nome = userNameInput.value || 'An칪nimo';
                    await canalChat.track({ user: nome, online_at: new Date().toISOString() });
                }
            });

        // --- INTERA칂칏ES ---

        // Avisar que estou digitando
        let typingTimeout;
        messageInput.addEventListener('input', () => {
            const nome = userNameInput.value || 'An칪nimo';
            
            // Envia o sinal de que est치 digitando
            canalChat.send({ type: 'broadcast', event: 'typing', payload: { nome, isTyping: true } });

            // Limpa o aviso ap칩s 2 segundos sem digitar
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                canalChat.send({ type: 'broadcast', event: 'typing', payload: { nome, isTyping: false } });
            }, 2000);
        });

        function renderMessage(nome, texto, isMine) {
            const div = document.createElement('div');
            div.className = `msg-box ${isMine ? 'mine' : 'others'}`;
            div.innerHTML = `<span class="user-label">${nome}</span> ${texto}`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function enviar() {
            const nome = userNameInput.value || 'An칪nimo';
            const texto = messageInput.value;
            if (!texto) return;

            await canalChat.send({
                type: 'broadcast',
                event: 'nova-mensagem',
                payload: { nome, texto }
            });

            renderMessage(nome, texto, true);
            messageInput.value = '';
            // For칞a sumir o "digitando" ao enviar
            canalChat.send({ type: 'broadcast', event: 'typing', payload: { nome, isTyping: false } });
        }

        document.getElementById('btnEnviar').onclick = enviar;
        
        // Atualiza o nome na presen칞a quando o usu치rio mudar o campo de nome
        userNameInput.onchange = () => {
            canalChat.track({ user: userNameInput.value, online_at: new Date().toISOString() });
        };
    </script>
</body>
</html>